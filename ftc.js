var INTEL_DATA ="TournamentMatchCode,Match,Result,Red1,Red2,Red3,Blue1,Blue2,Blue3,RTot,RAuto,RAutoB,RTele,REnd,RPen,BTot,BAuto,BAutoB,BTele,BEnd,BPen\n\
1617velv-canc-if-Q-1,Q-1,70-30 R,11182,3873,0,12105,10189,0,70,25,0,45,0,0,30,15,0,15,0,0\n\
1617velv-canc-if-Q-2,Q-2,95-130 B,9614,10794,0,8367,11920,0,95,25,0,20,40,10,130,100,0,30,0,0\n\
1617velv-canc-if-Q-3,Q-3,70-15 R,10320,3149,0,8625,11256,0,70,40,0,30,0,0,15,5,0,10,0,0\n\
1617velv-canc-if-Q-4,Q-4,85-20 R,4943,7464,0,6357,11475,0,85,30,0,45,10,0,20,10,0,10,0,0\n\
1617velv-canc-if-Q-5,Q-5,80-40 R,8625,8367,0,11548,12105,0,80,45,0,35,0,0,40,15,0,25,0,0\n\
1617velv-canc-if-Q-6,Q-6,35-35 T,10320,6357,0,3873,11920,0,35,5,0,30,0,0,35,20,0,15,0,0\n\
1617velv-canc-if-Q-7,Q-7,120-65 R,9614,7464,0,10794,11256,0,120,40,0,50,20,10,65,15,0,10,40,0\n\
1617velv-canc-if-Q-8,Q-8,35-50 B,3149,11475,0,11548,11182,0,35,10,0,15,10,0,50,10,0,30,0,10\n\
1617velv-canc-if-Q-9,Q-9,85-70 R,10189,11920,0,4943,8625,0,85,45,0,40,0,0,70,40,0,30,0,0\n\
1617velv-canc-if-Q-10,Q-10,75-5 R,11182,10320,0,7464,8367,0,75,35,0,40,0,0,5,0,0,5,0,0\n\
1617velv-canc-if-Q-11,Q-11,85-100 B,4943,10189,0,9614,3149,0,85,50,0,35,0,0,100,70,0,30,0,0\n\
1617velv-canc-if-Q-12,Q-12,110-65 R,10794,11475,0,3873,6357,0,110,35,0,55,20,0,65,50,0,15,0,0\n\
1617velv-canc-if-Q-13,Q-13,35-45 B,11256,12105,0,11548,11920,0,35,15,0,20,0,0,45,25,0,20,0,0\n\
1617velv-canc-if-Q-14,Q-14,10-100 B,3149,6357,0,8367,10320,0,10,10,0,0,0,0,100,35,0,65,0,0\n\
1617velv-canc-if-Q-15,Q-15,90-40 R,4943,11182,0,3873,11256,0,90,40,0,40,0,10,40,20,0,20,0,0\n\
1617velv-canc-if-Q-16,Q-16,55-155 B,12105,8625,0,11475,9614,0,55,25,0,30,0,0,155,80,0,25,40,10\n\
1617velv-canc-if-Q-17,Q-17,45-95 B,11548,10189,0,10794,7464,0,45,15,0,20,10,0,95,40,0,35,0,20\n\
1617velv-canc-if-Q-18,Q-18,100-48 R,8625,9614,0,6357,11182,0,100,60,0,20,10,10,48,0,0,48,0,0\n\
1617velv-canc-if-Q-19,Q-19,25-160 B,10320,12105,0,4943,10794,0,25,15,0,10,0,0,160,65,0,55,40,0\n\
1617velv-canc-if-Q-20,Q-20,40-70 B,7464,11920,0,3149,3873,0,40,30,0,10,0,0,70,35,0,35,0,0\n\
1617velv-canc-if-Q-21,Q-21,40-65 B,11475,11256,0,8367,10189,0,40,25,0,15,0,0,65,15,0,50,0,0\n\
1617velv-canc-if-Q-22,Q-22,60-130 B,11548,3873,0,10320,9614,0,60,35,0,25,0,0,130,85,0,5,40,0\n\
1617velv-canc-if-SF-1-1,SF-1-1,105-45 R,9614,10320,0,11920,3149,0,105,25,0,30,0,50,45,30,0,15,0,0\n\
1617velv-canc-if-SF-2-1,SF-2-1,210-95 R,8367,10794,0,11182,4943,0,210,105,0,25,0,80,95,35,0,60,0,0\n\
1617velv-canc-if-SF-1-2,SF-1-2,160-15 R,9614,10320,0,11920,3149,0,160,70,0,50,40,0,15,5,0,10,0,0\n\
1617velv-canc-if-SF-2-2,SF-2-2,140-80 R,8367,10794,0,11182,4943,0,140,100,0,30,0,10,80,40,0,30,0,10\n\
1617velv-canc-if-F-1,F-1,105-90 R,9614,10320,0,8367,10794,0,105,35,0,30,40,0,90,20,0,40,20,10\n\
1617velv-canc-if-F-2,F-2,125-120 R,9614,10320,0,8367,10794,0,125,85,0,20,20,0,120,40,0,40,40,0";

var GITHUB_DATA = "TournamentMatchCode,Match,Result,Red1,Red2,Red3,Blue1,Blue2,Blue3,RTot,RAuto,RAutoB,RTele,REnd,RPen,BTot,BAuto,BAutoB,BTele,BEnd,BPen\n\
1617velv-canc-gh-Q-1,Q-1,10-40 B,11311,8577,0,11898,9656,0,10,0,0,10,0,0,40,10,0,30,0,0\n\
1617velv-canc-gh-Q-2,Q-2,55-55 T,8872,3470,0,10761,10023,0,55,5,0,50,0,0,55,45,0,10,0,0\n\
1617velv-canc-gh-Q-3,Q-3,70-95 B,12136,8404,0,3873,6818,0,70,40,0,30,0,0,95,40,0,55,0,0\n\
1617velv-canc-gh-Q-4,Q-4,195-105 R,7591,9656,0,11898,3470,0,195,115,0,40,40,0,105,65,0,40,0,0\n\
1617velv-canc-gh-Q-5,Q-5,60-10 R,3873,12136,0,10761,11311,0,60,15,0,45,0,0,10,0,0,10,0,0\n\
1617velv-canc-gh-Q-6,Q-6,200-65 R,7591,10023,0,8577,8404,0,200,115,0,45,40,0,65,30,0,35,0,0\n\
1617velv-canc-gh-Q-7,Q-7,25-150 B,6818,11898,0,8872,3873,0,25,15,0,10,0,0,150,80,0,70,0,0\n\
1617velv-canc-gh-Q-8,Q-8,35-15 R,9656,8577,0,12136,10761,0,35,5,0,30,0,0,15,5,0,10,0,0\n\
1617velv-canc-gh-Q-9,Q-9,55-155 B,8872,11311,0,8404,7591,0,55,5,0,50,0,0,155,50,0,65,40,0\n\
1617velv-canc-gh-Q-10,Q-10,130-15 R,6818,3470,0,10023,8577,0,130,70,0,50,10,0,15,15,0,0,0,0\n\
1617velv-canc-gh-Q-11,Q-11,245-10 R,7591,8872,0,9656,12136,0,245,115,0,90,40,0,10,0,0,10,0,0\n\
1617velv-canc-gh-Q-12,Q-12,80-30 R,11311,3873,0,3470,10023,0,80,35,0,45,0,0,30,10,0,10,0,10\n\
1617velv-canc-gh-Q-13,Q-13,0-125 B,11898,10761,0,8404,6818,0,0,0,0,0,0,0,125,85,0,40,0,0\n\
1617velv-canc-gh-Q-14,Q-14,70-65 R,8577,3873,0,9656,8872,0,70,20,0,50,0,0,65,65,0,0,0,0\n\
1617velv-canc-gh-Q-15,Q-15,55-155 B,10761,6818,0,11311,7591,0,55,5,0,50,0,0,155,90,0,55,10,0\n\
1617velv-canc-gh-Q-16,Q-16,70-20 R,8404,11898,0,12136,3470,0,70,40,0,30,0,0,20,0,0,20,0,0\n\
1617velv-canc-gh-Q-17,Q-17,65-180 B,10023,3873,0,10761,7591,0,65,40,0,25,0,0,180,115,0,65,0,0\n\
1617velv-canc-gh-SF-1-1,SF-1-1,170-20 R,7591,8872,0,9656,11311,0,170,70,0,60,40,0,20,0,0,20,0,0\n\
1617velv-canc-gh-SF-2-1,SF-2-1,50-25 R,3873,8577,0,8404,11898,0,50,20,0,30,0,0,25,5,0,20,0,0\n\
1617velv-canc-gh-SF-1-2,SF-1-2,140-40 R,7591,8872,0,9656,11311,0,140,105,0,25,0,10,40,10,0,30,0,0\n\
1617velv-canc-gh-SF-2-2,SF-2-2,70-70 T,3873,8577,0,8404,11898,0,70,35,0,35,0,0,70,60,0,10,0,0\n\
1617velv-canc-gh-SF-2-3,SF-2-3,55-60 B,3873,8577,0,8404,11898,0,55,25,0,20,0,10,60,30,0,30,0,0\n\
1617velv-canc-gh-SF-2-4,SF-2-4,55-10 R,3873,8577,0,8404,11898,0,55,20,0,35,0,0,10,0,0,10,0,0\n\
1617velv-canc-gh-F-1,F-1,145-40 R,7591,8872,0,3873,8577,0,145,30,0,75,40,0,40,0,0,40,0,0\n\
1617velv-canc-gh-F-2,F-2,95-25 R,7591,8872,0,3873,8577,0,95,0,0,55,40,0,25,5,0,20,0,0"

var BURLINGAME_DATA = "TournamentMatchCode,Match,Result,Red1,Red2,Red3,Blue1,Blue2,Blue3,RTot,RAuto,RAutoB,RTele,REnd,RPen,BTot,BAuto,BAutoB,BTele,BEnd,BPen\n\
1617velv-canc-bu1-Q-1,Q-1,20-20 T,5211,9784,0,11689,11201,0,20,0,0,20,0,0,20,0,0,20,0,0\n\
1617velv-canc-bu1-Q-2,Q-2,170-30 R,7591,10794,0,4157,11387,0,170,100,0,70,0,0,30,0,0,30,0,0\n\
1617velv-canc-bu1-Q-3,Q-3,85-36 R,10189,548,0,11575,9965,0,85,55,0,30,0,0,36,5,0,21,10,0\n\
1617velv-canc-bu1-Q-4,Q-4,5-70 B,11643,11039,0,8865,5773,0,5,0,0,5,0,0,70,0,0,60,10,0\n\
1617velv-canc-bu1-Q-5,Q-5,5-76 B,8367,7593,0,9783,5206,0,5,5,0,0,0,0,76,30,0,46,0,0\n\
1617velv-canc-bu1-Q-6,Q-6,40-105 B,4157,8865,0,11689,548,0,40,15,0,25,0,0,105,70,0,35,0,0\n\
1617velv-canc-bu1-Q-7,Q-7,15-51 B,8367,11387,0,11039,11575,0,15,0,0,15,0,0,51,5,0,46,0,0\n\
1617velv-canc-bu1-Q-8,Q-8,10-235 B,5773,9783,0,7591,11201,0,10,0,0,10,0,0,235,130,0,85,20,0\n\
1617velv-canc-bu1-Q-9,Q-9,10-80 B,11643,5206,0,9965,5211,0,10,0,0,0,10,0,80,60,0,20,0,0\n\
1617velv-canc-bu1-Q-10,Q-10,70-80 B,10189,10794,0,7593,9784,0,70,20,0,50,0,0,80,50,0,20,10,0\n\
1617velv-canc-bu1-Q-11,Q-11,110-60 R,9965,11201,0,8865,8367,0,110,30,0,40,40,0,60,30,0,30,0,0\n\
1617velv-canc-bu1-Q-12,Q-12,10-40 B,7593,5773,0,11689,5211,0,10,5,0,5,0,0,40,10,0,30,0,0\n\
1617velv-canc-bu1-Q-13,Q-13,35-85 B,548,11643,0,11387,9784,0,35,15,0,20,0,0,85,20,0,25,0,40\n\
1617velv-canc-bu1-Q-14,Q-14,50-20 R,10794,11039,0,9783,10189,0,50,20,0,30,0,0,20,0,0,20,0,0\n\
1617velv-canc-bu1-Q-15,Q-15,20-80 B,5206,11575,0,7591,4157,0,20,0,0,20,0,0,80,60,0,20,0,0\n\
1617velv-canc-bu1-Q-16,Q-16,5-120 B,5211,8367,0,10794,548,0,5,5,0,0,0,0,120,45,0,75,0,0\n\
1617velv-canc-bu1-Q-17,Q-17,45-70 B,9783,8865,0,11575,9784,0,45,15,0,30,0,0,70,35,0,35,0,0\n\
1617velv-canc-bu1-Q-18,Q-18,135-150 B,11689,7591,0,9965,11039,0,135,100,0,35,0,0,150,60,0,50,40,0\n\
1617velv-canc-bu1-Q-19,Q-19,50-0 R,11387,10189,0,5206,5773,0,50,10,0,40,0,0,0,0,0,0,0,0\n\
1617velv-canc-bu1-Q-20,Q-20,40-45 B,4157,7593,0,11643,11201,0,40,0,0,0,0,40,45,5,0,40,0,0\n\
1617velv-canc-bu1-Q-21,Q-21,90-75 R,8865,5211,0,10189,7591,0,90,5,0,25,0,60,75,0,0,55,20,0\n\
1617velv-canc-bu1-Q-22,Q-22,25-60 B,11039,11201,0,548,5206,0,25,5,0,20,0,0,60,30,0,30,0,0\n\
1617velv-canc-bu1-Q-23,Q-23,20-5 R,9784,5773,0,8367,4157,0,20,20,0,0,0,0,5,5,0,0,0,0\n\
1617velv-canc-bu1-Q-24,Q-24,35-45 B,11689,11575,0,10794,11643,0,35,5,0,30,0,0,45,10,0,35,0,0\n\
1617velv-canc-bu1-Q-25,Q-25,0-80 B,11387,9965,0,9783,7593,0,0,0,0,0,0,0,80,35,0,45,0,0";

var CSV = {
  parse: function(str) {
    var lines = str.split("\n");
    var items = [];
    var header = lines[0].split(",");
    for (var i = 1; i < lines.length; i++) {
      var item = {};
      var parts = lines[i].split(",");
      for (var j = 0; j < parts.length; j++) {
        var part = parts[j];
        if (part == "") {
          continue;
        }
        if (!isNaN(parseInt(part, 10))) {
          part = parseInt(part, 10);
        }
        item[header[j]] = part;
      }
      if (item == {}) {
        continue;
      }
      items.push(item);
    }
    return items;
  },
  stringify: function(items) {
    var str = "";
    var header = [];
    var firstItem = items[0];
    for (var key in firstItem) {
      if (firstItem.hasOwnProperty(key)) {
        header.push(key);
        str += key + ",";
      }
    }
    for (var i = 0; i < items.length; i++) {
      str += "\n";
      for (var j = 0; j < header.length; j++) {
        str += items[i][header[j]] + ",";
      }
    }
    return str;
  },
  save: function (data, fileName) {
    var a = document.createElement("a");
    document.body.appendChild(a);
    a.style = "display: none";
    var csv = CSV.stringify(data),
        blob = new Blob([csv], {type: "octet/stream"}),
        url = window.URL.createObjectURL(blob);
    a.href = url;
    a.download = fileName;
    a.click();
    window.URL.revokeObjectURL(url);
  }
}

JSON.values = function(data) {
  var vals = [];
  for (var key in data) {
    if (data.hasOwnProperty(key)) {
      vals.push(data[key]);
    }
  }
  return vals;
}

var INPUT_HTML = '<input type="text" style="width: 100%" />';

// var MATCH_DATA = [];
//
// var testData = CSV.parse(INTEL_DATA);
// for (var i = 0; i < 22; i++) {
//   var m = {};
//   m.match = (i + 1);
//   m.red1 = testData.Red1[i];
//   m.red2 = testData.Red2[i];
//   m.blue1 = testData.Blue1[i];
//   m.blue2 = testData.Blue2[i];
//   m.redScore = testData.RTot[i] - testData.RPen[i];
//   m.blueScore = testData.BTot[i] - testData.BPen[i];
//   MATCH_DATA.push(m);
// }

function MatchTable(schema, $tbody) {
  this.schema = schema;
  this.items = [];
  this.$tbody = $tbody;

  var this_ = this;
  this.$tbody.on("blur", "div.input input", function(evt) {
    var $this = $(this);
    var val = $this.val();
    if (this_.isValid(val)) {
      var $parent = $this.parent();
      var $td = $parent.parent();
      this_.items[this_.getRow($td)][this_.schema[this_.getCol($td)]] = parseInt(val, 10);
      $parent.html(val);
      $parent.removeClass("editing");
      updateRankings();
    }
  });

  this.$tbody.on("dblclick", "td", function(evt) {
    var $this = $(this).find("div.input");
    var val = $this.html();
    if (!$this.hasClass("editing")) {
      $this.html(INPUT_HTML);
      $this.addClass("editing");
      var $input = $this.find("input");
      $input.val(val);
      $input.focus();
      $input.select();
    }
  });
}
MatchTable.prototype = {
  add: function(data) {
    var html = "<tr><td>" + (this.items.length + 1) + "</td>";

    if (typeof data == "undefined") {
      data = {};
      for (var i = 1; i < this.schema.length; i++) {
        html += '<td><div class="ui input editing">' + INPUT_HTML + '</td></div>';
        data[this.schema[i]] = 0;
      }
    } else {
      for (var i = 1; i < this.schema.length; i++) {
        html += '<td><div class="ui input">' + data[this.schema[i]] + '</td></div>';
      }
    }
    this.items.push(data);

    html += "</tr>";

    this.$tbody.append(html);
  },
  remove: function(index) {
    this.items.splice(index, 1);
    this.$tbody.find('tr').each(function(i, el) {
      if (index == i) {
        $(el).remove();
      }
    });
  },
  size: function() {
    return this.items.length;
  },
  isValid: function(input) {
    return input.match(/^\d+\*?$/);
  },
  getItems: function() {
    return this.items;
  },
  getCol: function($el) {
    return $el.parent().children().index($el);
  },
  getRow: function($el) {
    return $el.parent().parent().children().index($el.parent());
  }
};

var Competition = {
  computeStats: function(matches) {
    var teamNums = [], teamDetails = [], numTeams = 0;
    for (var i = 0; i < matches.length; i++) {
      for (var j = 0; j < 4; j++) {
        var team = matches[i][["red1", "red2", "blue1", "blue2"][j]];
        if (teamNums.indexOf(team) == -1) {
          numTeams += 1;
          teamNums.push(team);
          teamDetails.push({
            number: team,
            opr: 0,
            qp: 0,
            rp: 0
          });
        }
      }
    }

    console.log(teamNums);

    var A = [], b = [];
    for (var i = 0; i < numTeams; i++) {
      var temp = [];
      for (var j = 0; j < numTeams; j++) {
        temp.push(0);
      }
      A.push(temp);
      b.push(0);
    }

    for (var i = 0; i < matches.length; i++) {
      var match = matches[i];
      var red1 = teamNums.indexOf(match.red1);
      var red2 = teamNums.indexOf(match.red2);
      var blue1 = teamNums.indexOf(match.blue1);
      var blue2 = teamNums.indexOf(match.blue2);

      A[red1][red1] += 1;
      A[red1][red2] += 1;
      b[red1] += (match.redScore - match.redPenalty);
      A[red2][red1] += 1;
      A[red2][red2] += 1;
      b[red2] += (match.redScore - match.redPenalty);
      A[blue1][blue1] += 1;
      A[blue1][blue2] += 1;
      b[blue1] += (match.blueScore - match.bluePenalty);
      A[blue2][blue1] += 1;
      A[blue2][blue2] += 1;
      b[blue2] += (match.blueScore - match.bluePenalty);

      if (match.redScore == match.blueScore) {
        teamDetails[red1].qp += 1;
        teamDetails[red2].qp += 1;
        teamDetails[blue1].qp += 1;
        teamDetails[blue2].qp += 1;
      } else if (match.redScore > match.blueScore) {
        teamDetails[red1].qp += 2;
        teamDetails[red2].qp += 2;
      } else {
        teamDetails[blue1].qp += 2;
        teamDetails[blue2].qp += 2;
      }

      var smallerScore = match.redScore > match.blueScore ? match.blueScore : match.redScore;
      teamDetails[red1].rp += smallerScore;
      teamDetails[red2].rp += smallerScore;
      teamDetails[blue1].rp += smallerScore;
      teamDetails[blue2].rp += smallerScore;
    }

    var startTime = (new Date()).getTime();
    var x = numeric.solve(A, b);
    console.log("solution took " + ((new Date()).getTime() - startTime) + "ms");
    for (var i = 0; i < numTeams; i++) {
      teamDetails[i].opr = x[i];
    }

    teamDetails.sort(function(a, b) {
      if (a.opr < b.opr) {
        return 1;
      } else if (a.opr > b.opr) {
        return -1;
      } else {
        return 0;
      }
    });

    for (var i = 0; i < teamNums; i++) {
      var diff = 0;
      if (i != 0) {
        diff = teamDetails[i - 1].opr - teamDetails[i].opr;
      }
      console.log((i + 1) + ".\t\t" + teamDetails[i].number + " \t\t" + teamDetails[i].opr.toFixed(2) + "\t\t-" + diff.toFixed(2));
    }
    return teamDetails;
  }
};
